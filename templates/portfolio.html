{% extends "base.html" %}
{% load static %}

{% block extra_head %}{{ block.super }}
<link rel="stylesheet" href="{% static 'css/magnific-popup.min.css' %}">
<style>
    .image-effect-one {
        position: relative
    }

    .add-card {
        aspect-ratio: 4 / 3;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: #f7f7f7;
        border: 1px dashed #cfd8dc;
        border-radius: 6px;
        text-decoration: none
    }

    .add-card .add-plus {
        font-size: 32px;
        line-height: 1
    }

    .add-card .add-label {
        font-weight: 600
    }

    @supports not (aspect-ratio:1) {
        .add-card {
            min-height: 240px
        }
    }

    .portfolio-title-bar {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        padding: 12px 14px;
        border-top: 1px solid #eee
    }

    .portfolio-wrap .image-effect-one .figcaption {
        position: absolute;
        right: 10px;
        bottom: 10px;
        z-index: 6;
        background: transparent;
        padding: 0;
        border: 0
    }

    .portfolio-wrap .image-effect-one .figcaption .empty50 {
        display: none;
    }

    .image-effect-one .figcaption a {
        display: inline-flex;
        align-items: center;
        justify-content: center
    }

    /* inline modal shell */
    .ap-modal {
        max-width: 960px;
        margin: 0 auto;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .2)
    }

    .ap-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #0f172a;
        color: #fff;
        padding: 14px 18px;
        font-weight: 600
    }

    .ap-body {
        padding: 18px;
        max-height: 70vh;
        overflow: auto
    }

    .ap-body form .submit-row {
        display: flex;
        gap: 8px
    }
</style>
{% endblock %}

{% block title %}Portfolio | HMD Klusbedrijf{% endblock %}

{% block content %}
<div class="mt-bnr-inr overlay-wraper bg-parallax bg-top-center" data-stellar-background-ratio="0.5"
    style="background-image:url('{% static 'img/background/banner-default.jpg' %}')">
    <div class="overlay-main bg-black opacity-07"></div>
    <div class="container">
        <div class="mt-bnr-inr-entry">
            <div class="banner-title-outer">
                <div class="banner-title-name">
                    <h2 class="m-b0">Portfolio</h2>
                </div>
            </div>
            <div>
                <ul class="mt-breadcrumb breadcrumb-style-2">
                    <li><a href="{% url 'index' %}">Home</a></li>
                    <li>Portfolio</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="section-full p-tb80 bg-gray inner-page-padding">
    <div class="container-fluid">

        <div class="filter-wrap p-b30 text-center">
            <ul id="portfolioFilters"
                class="filter-navigation inline-navigation masonry-filter link-style text-uppercase">
                <li class="active"><a href="#" data-filter="*">All</a></li>
                <li><a href="#" data-filter=".cat-keuken">Keuken</a></li>
                <li><a href="#" data-filter=".cat-badkamer">Badkamer</a></li>
                <li><a href="#" data-filter=".cat-vloeren">Vloeren</a></li>
                <li><a href="#" data-filter=".cat-klus-en-reparatiewerk">Klus en Reparatiewerk</a></li>
                <li><a href="#" data-filter=".cat-stukwerk">Stukwerk</a></li>
            </ul>

            {% if request.GET.preview %}
            <a href="#" class="site-button m-l10 js-admin-form" data-admin-formurl="/admin/core/portfolioitem/add/">
                Insert new
            </a>
            {% endif %}
        </div>

        <div class="portfolio-wrap mfp-gallery work-grid row clearfix">
            {% for item in items %}
            <div class="masonry-item cat-{{ item.category_slug }} col-xl-3 col-lg-4 col-md-6 col-sm-6 m-b30">
                <div class="image-effect-one hover-shadow">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.title|default:'Projectfoto' }}">
                    <a class="mfp-link" href="{{ item.image.url }}"><i class="fa fa-arrows-alt"
                            aria-hidden="true"></i></a>
                    {% else %}
                    <img src="{% static 'img/placeholder-portfolio.jpg' %}"
                        alt="{{ item.title|default:'Projectfoto' }}">
                    {% endif %}

                    <div class="figcaption">
                        <a class="mfp-link" href="{{ item.image.url }}"><i class="fa fa-search-plus"
                                aria-hidden="true"></i></a>
                    </div>

                    <div class="portfolio-title-bar">
                        <h6 style="margin:0;font-weight:600;font-size:14px;">
                            {% firstof item.title item.caption item.name "Untitled item" %}
                        </h6>
                    </div>

                    {% if request.GET.preview %}
                    <a href="#" class="admin-edit-btn js-admin-form"
                        data-admin-formurl="/admin/core/portfolioitem/{{ item.id }}/change/" title="Edit item"
                        style="position:absolute;left:12px;top:12px;z-index:7;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:16px;background:#2b6cb0;color:#fff;font-size:12px;text-decoration:none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
                            <path
                                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" />
                        </svg>
                        Edit
                    </a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center p-b30">Nog geen portfolio-items.</div>
            {% endfor %}

            {% if request.GET.preview %}
            <div class="masonry-item col-xl-3 col-lg-4 col-md-6 col-sm-6 m-b30">
                <a href="#" class="image-effect-one hover-shadow add-card js-admin-form"
                    data-admin-formurl="/admin/core/portfolioitem/add/">
                    <span class="add-plus">+</span><span class="add-label">Insert new</span>
                </a>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<script>
    /* filter */
    document.addEventListener('DOMContentLoaded', function () {
        const wrap = document.querySelector('.portfolio-wrap');
        const ul = document.getElementById('portfolioFilters');
        if (!wrap || !ul) return;
        ul.addEventListener('click', function (e) {
            const a = e.target.closest('a[data-filter]'); if (!a) return;
            e.preventDefault();
            ul.querySelectorAll('li').forEach(li => li.classList.remove('active'));
            a.parentElement.classList.add('active');
            const sel = a.getAttribute('data-filter');
            wrap.querySelectorAll('.masonry-item').forEach(card => {
                card.style.display = (sel === '*' || card.matches(sel)) ? '' : 'none';
            });
        });
    });
</script>
{% block extra_js %}{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        /* Magnific Popup for images */
        if (window.jQuery && jQuery.fn.magnificPopup) {
            jQuery('.portfolio-wrap').magnificPopup({
                delegate: 'a.mfp-link',
                type: 'image',
                gallery: { enabled: true }
            });
        }

        async function openAdminForm(url) {
            const html = await fetch(url, { credentials: 'include' }).then(r => r.text());
            const doc = new DOMParser().parseFromString(html, 'text/html');

            // Pick the real admin form, not the small changelist search form.
            const forms = Array.from(doc.querySelectorAll('form'));
            let form = forms
                .filter(f => f.querySelector('input[name="csrfmiddlewaretoken"]'))       // must have CSRF
                .filter(f => !/changelist-search/i.test(f.id || ''))                    // not the search box
                .sort((a, b) => (b.querySelectorAll('input,select,textarea').length) -
                    (a.querySelectorAll('input,select,textarea').length))[0];

            if (!form) { window.location.href = url; return; }

            const shell = document.createElement('div');
            shell.className = 'ap-modal';
            const title = (doc.querySelector('#content h1') || {}).textContent || 'Edit';
            shell.innerHTML = '<div class="ap-header">' + title + '</div><div class="ap-body"></div>';
            shell.querySelector('.ap-body').appendChild(form);

            form.addEventListener('submit', async function (ev) {
                ev.preventDefault();
                const fd = new FormData(form);
                const resp = await fetch(form.action, {
                    method: 'POST', body: fd, credentials: 'include', redirect: 'follow'
                });
                // On success Django redirects to changelist. Reload page.
                if (resp.redirected) { window.location.reload(); return; }
                // Otherwise, re-render returned form (validation errors)
                const txt = await resp.text();
                const doc2 = new DOMParser().parseFromString(txt, 'text/html');
                const forms2 = Array.from(doc2.querySelectorAll('form'))
                    .filter(f => f.querySelector('input[name="csrfmiddlewaretoken"]'))
                    .filter(f => !/changelist-search/i.test(f.id || ''))
                    .sort((a, b) => (b.querySelectorAll('input,select,textarea').length) -
                        (a.querySelectorAll('input,select,textarea').length));
                const form2 = forms2[0];
                if (!form2) { window.location.reload(); return; }
                shell.querySelector('.ap-body').innerHTML = '';
                shell.querySelector('.ap-body').appendChild(form2);
            });

            if (window.jQuery && jQuery.magnificPopup) {
                jQuery.magnificPopup.open({ items: { src: shell }, type: 'inline' });
            } else {
                document.body.innerHTML = ''; document.body.appendChild(shell);
            }
        }

        document.addEventListener('click', function (e) {
            const a = e.target.closest('a.js-admin-form[data-admin-formurl]');
            if (!a) return;
            e.preventDefault();
            openAdminForm(a.getAttribute('data-admin-formurl'));
        });
    });
</script>
{% endblock %}

{% endblock %}